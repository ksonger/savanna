<?xml version="1.0" encoding="utf-8"?>
<project name="savanna-ant-tasks" default="savanna-rebase-master">

    <property file="../savanna-client.properties" prefix="maven"/>

    <!--
        Starts up the JsCover server, testing that it can hit the standard report page generated by said server
    -->
    <target name="jscover-start">
        <java jar="${settings.localRepository}/com/github/tntim96/JSCover/1.0.2/JSCover-1.0.2.jar" fork="true" spawn="true">
            <arg value="-ws"/>
            <arg value="--document-root=${basedir}"/>
            <arg value="--report-dir=${basedir}/${maven.jscover.reportdir}"/>
            <!-- NOTE: add any directories of JavaScript that should NOT get coverage reporting below -->
            <arg value="--no-instrument=ext"/>
            <arg value="--no-instrument=resources"/>
            <arg value="--no-instrument=test"/>
            <arg value="--no-instrument=app/flexpaper"/>
        </java>
        <waitfor maxwait="5" maxwaitunit="second" checkevery="250" checkeveryunit="millisecond" timeoutproperty="failed">
            <http url="http://localhost:8080/jscoverage.html"/>
        </waitfor>
        <fail if="failed"/>
    </target>

    <!--
        Runs PhantomJS tests against the JsCover server
    -->
    <target name="jscover-test" depends="jscover-start">
        <exec executable="phantomjs" dir="test">
            <arg value="lib/run-jscover-jasmine.js"/>
            <arg value="${basedir}/${maven.jscover.reportdir}/${maven.surefire.outputdir}"/>
            <arg value="http://localhost:8080/test/SpecRunner.html"/>
        </exec>
    </target>

    <!--
        Kills the JsCover server by hitting a URL that tells it to shutdown
    -->
    <target name="jscover-stop">
        <get src="http://localhost:8080/stop" dest="test/stop-jscover.txt" />
    </target>

    <!--
        Generates the cobertura format reports
    <target name="jscover-generate-cobertura" depends="jscover-test,jscover-stop" description="runs unit tests, generating surefire unit-test and cobertura coverage reports">
        <java classpath="${user.home}/.m2/repository/com/github/tntim96/JSCover/0.3.0/JSCover-0.3.0.jar" classname="jscover.report.Main">
            <arg value="_-format=COBERTURAXML"/>
            <arg value="${basedir}/${maven.jscover.reportdir}${maven.jscover.outputdir}"/>
            <arg value="${basedir}/${maven.jscover.reportdir}${maven.jscover.outputdir}/original-src/app"/>
        </java>
    </target>
    -->

    <!--
        Helper to rebase your local repos from the canonical upstream Thetus GitHub repos
        NOTE:
            Expects that you have run "git remote add upstream htttps://github.com/path/to/thetus/repos.git"
    -->
    <target name="savanna-checkout-master" description="checks out the 'master' git branch">
        <exec executable="git">
            <arg value="checkout"/>
            <arg value="master"/>
        </exec>
    </target>

    <target name="savanna-checkout-map" description="checks out the 'MapPrototype' git branch">
        <exec executable="git">
            <arg value="checkout"/>
            <arg value="MapPrototype"/>
        </exec>
    </target>

    <target name="savanna-fetch" description="fetches upstream (i.e. ThetusCorportation repos) changes">
        <exec executable="git">
            <arg value="fetch"/>
            <arg value="--progress"/>
            <arg value="--prune"/>
            <arg value="upstream"/>
        </exec>
    </target>

    <target name="savanna-rebase-master" depends="savanna-checkout-map,savanna-fetch" description="fetches/rebases the master branch from the upstream repos">
        <exec executable="git">
            <arg value="rebase"/>
            <arg value="-v"/>
            <arg value="-m"/>
            <arg value="refs/remotes/upstream/master"/>
        </exec>
    </target>

    <target name="savanna-rebase-map" depends="savanna-checkout-map,savanna-fetch" description="fetches/rebases the MapPrototype branch from the upstream repos">
        <exec executable="git">
            <arg value="rebase"/>
            <arg value="-v"/>
            <arg value="-m"/>
            <arg value="refs/remotes/upstream/MapPrototype"/>
        </exec>
    </target>
</project>
